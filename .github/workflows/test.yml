name: test
on: [push]
jobs:
  unittests:
    strategy:
      matrix:
        os: ["ubuntu:20.04", "ubuntu:22.04"]
        package: ["planning/templ"]
        seed_config: [".ci/autoproj-config.yml"]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: 2maz/rock-github-workflow
          path: rock-github-workflow
          ref: test

      - name: Apply package / branch specific overrides
        run:
          if [ -d .ci/overrides.d/ ]; then
             echo "Copying overrides from .ci/"
             cp -R .ci/overrides.d/* rock-github-workflow/docker/overrides.d/;
          fi

      - name: Build
        run: docker build -t rock/${{ matrix.os }} -f rock-github-workflow/docker/Dockerfile .
                --build-arg PKG_NAME=${{ matrix.package }}
                --build-arg PKG_BRANCH=${{ github.ref_name }}
                --build-arg BASE_IMAGE=${{ matrix.os }}
                --build-arg SEED_CONFIG=${{ matrix.seed_config }}
                --build-arg BUILDCONF_URL=https://github.com/2maz/templ-buildconf
                --build-arg BUILDCONF_BRANCH=test

      - name: Test
        run: docker run rock/${{ matrix.os }}
                /bin/bash -c
                  "source /home/docker/rock_test/env.sh; BOOST_TEST_CATCH_SYSTEM_ERRORS=\"no\" make -C /home/docker/rock_test/${{ matrix.package }}/build test"

